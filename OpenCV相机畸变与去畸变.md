## OpenCV 相机畸变与去畸变

[TOC]

### 一、畸变的类型

相机的畸变主要分成径向畸变(radical distortion)和切向畸变(slight tangential distortion)，针对两种畸变可以用如下两个不同的方程去描述它。

对于径向畸变：
$$
u_d = u(1+k_1r^2+k_2r^4+k_3r^6) \\
v_d = v(1+k_1r^2+k_2r^4+k_3r^6)
$$
对于切向畸变：
$$
u_d= u+[2p_1v+p_2(r^2+2u^2)] \\
v_d =v+[p_1(r^2+2v^2)+2p_2u]
$$
其中$r^2=u^2+v^2$所以对于一般的相机，其畸变可以用五个参数$k_1,k_2,k_3,p_1,p_2$来描述。

在`OpenCV`中相机模型可以用如下等式来描述：
$$
\begin{array}{l}

p=[x,y,z]^T \\
x' = x/z \\ y' = y/z \\ x'' = x'  \frac{1 + k_1 r^2 + k_2 r^4 + k_3 r^6}{1 + k_4 r^2 + k_5 r^4 + k_6 r^6} + 2 p_1 x' y' + p_2(r^2 + 2 x'^2)  \\ y'' = y'  \frac{1 + k_1 r^2 + k_2 r^4 + k_3 r^6}{1 + k_4 r^2 + k_5 r^4 + k_6 r^6} + p_1 (r^2 + 2 y'^2) + 2 p_2 x' y'  \\ \text{where} \quad r^2 = x'^2 + y'^2  \\ u = f_x*x'' + c_x \\ v = f_y*y'' + c_y \end{array}
$$
其中$k_1,k_2,k_3,k_4,k_5,k_6$为径向畸变系数，$p_1,p_2$为切向畸变系数。

函数调用的时候传入的参数形式一般为$[k_1,k_2,p_1,p_2,[k_3[,k_4,k_5,k_6]]]$

一般情况五个参数就已经足够了。



### 二、图像去畸变

图像去畸变要完成的工作是利用已经标定出来的参数，把畸变图像变回原来的样子，对于鱼眼镜头等畸变较大的镜头十分有必要，因为其成像的结果中的几何形状变形严重。

假设未发生畸变前，图像中像素的坐标与点的坐标关系如下：
$$
z\begin{bmatrix}
u\\
v\\
1\\
\end{bmatrix}
=K
\begin{bmatrix}
x\\
y\\
z
\end{bmatrix}
$$
去畸变操作一般在单位成像平面上完成，所以首先要将像素坐标点反投影到单位成像平面上：
$$
\begin{bmatrix}
x' \\
y'\\
1
\end{bmatrix}
=K^{-1}
\begin{bmatrix}
u\\
v\\
1\\
\end{bmatrix}
$$
在利用畸变公式求出畸变后的单位像素平面坐标：
$$
\begin{array}{l}
 x'' = x'  \frac{1 + k_1 r^2 + k_2 r^4 + k_3 r^6}{1 + k_4 r^2 + k_5 r^4 + k_6 r^6} + 2 p_1 x' y' + p_2(r^2 + 2 x'^2)  \\ y'' = y'  \frac{1 + k_1 r^2 + k_2 r^4 + k_3 r^6}{1 + k_4 r^2 + k_5 r^4 + k_6 r^6} + p_1 (r^2 + 2 y'^2) + 2 p_2 x' y'  \\ \text{where} \quad r^2 = x'^2 + y'^2  \\ \end{array}
$$
求出畸变后的单位成像平面坐标之后，将其投影到图像平面并获得其图像坐标$(u_d,v_d)$：
$$
u_d = f_x*x'' + c_x \\ v_d = f_y*y'' + c_y
$$
所以对于去畸变后的图像，其坐标为$(u,v)$处的像素处，对应的值应该为当前畸变图像中$(u_d,v_d)$

处的值，但是由于$(u_d,v_d)$一般都不是整数，所以需要对其进行插值处理，一般采用双线性插值即可。

另外有些$(u,v)$处对应的$(u_d,v_d)$可能已经超出了图像的边界，所以一般直接去畸变的结果图像一般会有一些黑色的空洞区域。一般后续操作可以选择对图像进行裁剪，以使得获取完整的矩形图像而没有空洞。



### 三、代码中部分公式的解释

在`OpenCV`以及各种代码中，利用$x'',y''$来反向求$x',y'$的过程中，一般都用到了迭代法，下面对公式进行简单的介绍，方便对代码的理解：

问题描述如下：

已知: $x'',y''$的值，求$x',y'$的值，其中二者的关系如下：
$$
\begin{array}{l}
 x'' = x'  \frac{1 + k_1 r^2 + k_2 r^4 + k_3 r^6}{1 + k_4 r^2 + k_5 r^4 + k_6 r^6} + 2 p_1 x' y' + p_2(r^2 + 2 x'^2)  \\ y'' = y'  \frac{1 + k_1 r^2 + k_2 r^4 + k_3 r^6}{1 + k_4 r^2 + k_5 r^4 + k_6 r^6} + p_1 (r^2 + 2 y'^2) + 2 p_2 x' y'  \\ \text{where} \quad r^2 = x'^2 + y'^2  \\ \end{array}
$$
解法：

利用`简单迭代法`进行迭代求解:

记:
$$
A = \frac{1 + k_1 r^2 + k_2 r^4 + k_3 r^6}{1 + k_4 r^2 + k_5 r^4 + k_6 r^6} \\
B = 2 p_1 x' y' + p_2(r^2 + 2 x'^2) \\
C = p_1 (r^2 + 2 y'^2) + 2 p_2 x' y' 
$$
原式可以化简为：
$$
x'' = Ax'+B \\
y'' = Ay' + C \\
$$
根据简单迭代法：
$$
x' = (x''-B)/A \\
y' = (y''-C)/A \\
$$
流程如下：

1. 选取初值：

$$
x_0 = x'' ,y_0 = y''
$$

2. 利用$x_n,y_n$计算$A,B,C$的值

3. 计算$x_{n+1},y_{n+1}$的值 
   $$
   x_{n+1} = (x_n -B)/A \\
   y_{n+1} = (y_n-C)/A \\
   $$


重复迭代数次之后给出结果(收敛性如何判定？)。